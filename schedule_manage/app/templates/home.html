{% extends 'base.html' %}
{% block content %}

<div id="help-link">
  <a href="{% url 'calendar_info' %}">ğŸ“˜ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ä½¿ã„æ–¹</a>
</div>

<div id="calendar-wrapper">
  <div id="calendar"></div>
</div>
     
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    
<style>
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾ç­– */
    #calendar-wrapper {
        max-height: 600px;           /* â† ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é«˜ã•ã«å¿œã˜ã¦èª¿æ•´å¯ */
        overflow-y: auto;            /* â† ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ã“ã“ã«è¡¨ç¤º */
        padding-right: 8px;          /* â† ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã®é–“ã«ä½™ç™½ */
        box-sizing: border-box;
    }

    #calendar {
        max-width: 740px;
        margin: 0px auto;
        padding: 20px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    .fc-daygrid-day-number {
        text-align: left;
        padding-left: 4px;
    }
    .fc-toolbar.fc-header-toolbar {
        justify-content: center; /* æœˆæ—¥ã®å·¦å³ã«çŸ¢å° *//
    }  
    .fc-toolbar-title {
        color: #777 !important;  /* è–„ã‚ã®ã‚°ãƒ¬ãƒ¼ */
        font-weight: 600;
    }
    .fc-button.fc-prev-button,
    .fc-button.fc-next-button {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
        color: #888 !important;
        font-size: 1.4rem;
        padding: 0 8px;
        min-width: auto !important;
        height: auto !important;
    }

    .fc-button.fc-prev-button:hover,
    .fc-button.fc-next-button:hover {
        color: #000; 
        background-color: #f0f0f0 !important;
        border-radius: 5px;
        cursor: pointer;
    }

    .fc-col-header-cell:first-child .fc-col-header-cell-cushion {
        color: #ff6666; /* æ—¥æ›œ */
    }
    
    .fc-col-header-cell {
        background-color: #fdf5e6;
        border-bottom: 1px solid #ddd; /*æ—¥ï½åœŸã®è¡Œã®è‰²*/
    }

    .fc-col-header-cell:nth-child(2) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(3) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(4) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(5) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(6) .fc-col-header-cell-cushion {
        color: #999999; /* æœˆã€œé‡‘ï¼šè–„ã‚°ãƒ¬ãƒ¼ */
    }

    .fc-col-header-cell:last-child .fc-col-header-cell-cushion {
        color: #6699ff; /* åœŸæ›œ */
    }
    .fc-event,
    .fc-event-title,
    .fc-daygrid-day {
        cursor: pointer;
    }

    /* ã‚¤ãƒ™ãƒ³ãƒˆæ å…¨ä½“ã®ãƒ›ãƒãƒ¼ */
    .fc-event:hover {
        background-color: #f0f8ff;
        box-shadow: 0 0 5px #007BFF;
        transition: 0.2s ease;
    }

    /* ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«æ–‡å­—ã®ãƒ›ãƒãƒ¼ */
    .fc-event-title:hover {
        color: #007BFF;
        text-decoration: underline;
    }

    /* æ—¥ä»˜ã‚»ãƒ«ãƒ›ãƒãƒ¼ */
        .fc-daygrid-day:hover {
        background-color: #f9f9f9;
    }
    
</style> 
    
<script>
    document.addEventListener('DOMContentLoaded', function () {
        
        const calendarEl = document.getElementById('calendar');
        
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ja',
            headerToolbar: {
                left: 'prev', //43~45ã®ä¸¦ã³ã¯å´©ã•ãªã„å¹´æœˆã®éš£ã«å·¦å³çŸ¢å°
                center: 'title',
                right: 'next'
            },
            buttonText: {
                prev: 'â—€ï¸',
                next: 'â–¶ï¸'
            },
            displayEventTime: false, //ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æ™‚é–“è¡¨ç¤ºã•ã›ãªã„ã‚ˆã†ã«ã—ã¦ã„ã‚‹
            eventDisplay: 'block', //ã“ã‚Œã‚’ã„ã‚Œã¦è¦‹å‡ºã—ã‚«ãƒ©ãƒ¼ã‚’å¸¯ã§è¡¨ç¤º
            events: '/schedule/json/', 

            dateClick: function(info) {
                const clickedDate = info.dateStr;
                window.location.href = `/schedule/create?date=${clickedDate}`;
            },


            eventDataTransform: function(eventData) {
                if (eventData._id) {
                    eventData.id = eventData._id;  // è¡¨ç¤ºã«ã¯ _id ã‚’ä½¿ã†ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹ï¼‰è¤‡æ•°ã®ç¹°ã‚Šè¿”ã—äºˆå®šã®ãŸã‚
                }
                return eventData;
            },

            eventClick: function(info) {
                const scheduleId = info.event.extendedProps.original_id;
                const cellEl = info.jsEvent.target.closest('.fc-daygrid-day');
                let clickedDate = null;
                if (cellEl) {
                    clickedDate = cellEl.getAttribute('data-date');
                }
                // æœ€å¾Œã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã®startæ—¥ï¼‰
                if (!clickedDate) {
                    clickedDate = info.event.startStr.split('T')[0];
                }
                
                window.location.href = `/schedule/${scheduleId}/?date=${clickedDate}`;
            },

            eventDidMount: function(info) {
                try {
                    if (!info.event.extendedProps.color) {
                    info.el.style.backgroundColor = info.event.extendedProps.color;
                    info.el.style.color = 'black';
                    info.el.style.border = '1px solid #ccc';
                    }
                    const titleEl = info.el.querySelector('.fc-event-title');
                    if (titleEl) {
                    titleEl.style.color = 'black';
                    titleEl.style.fontWeight = 'bold';
                    }
                    const startDate = info.event.start;
                    if (startDate) {
                        const y = info.event.start.getFullYear();
                        const m = String(info.event.start.getMonth() + 1).padStart(2, '0');
                        const d = String(info.event.start.getDate()).padStart(2, '0');
                        const dateStr = `${y}-${m}-${d}`;
                        info.el.setAttribute('data-date', dateStr);
                    }
                } catch (e) {
                    console.error('eventDidMount error:', e);
                }
            },
            dayCellContent: function(arg) {
                return arg.date.getDate();
            },
            dayCellDidMount: function(arg) {
                const day = arg.date.getDay(); //0:æ—¥æ›œã€ 6:åœŸæ›œ
                const numberEl = arg.el.querySelector('.fc-daygrid-day-number');

                if (numberEl){
                  if (day === 0) {
                    numberEl.style.color = '#ff6666'; // æ—¥æ›œâ†’èµ¤
                  } else if (day === 6) {
                    numberEl.style.color = '#6699ff'; // åœŸæ›œâ†’é’
                  } else{
                    numberEl.style.color = '#999999' // å¹³æ—¥â†’ã‚°ãƒ¬ãƒ¼
                  }
                }
            },
        });
        calendar.render();
    });
</script>    
{% endblock %}
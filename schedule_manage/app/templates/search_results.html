{% extends 'base.html' %}
{% block content %}

<h2>「{{ query }}」の検索結果</h2>

<h3>【該当する予定があります】</h3>
<div class="row row-cols-1 row-cols-md-2 g-4">
  {% for schedule in schedules %}
    <div class="col">
      <div class="card h-100">
        {% if schedule.image %}
          <img src="{{ schedule.image.url }}" class="card-img-top" alt="予定画像">
        {% endif %}
        <div class="card-body">
          <h5 class="card-title">{{ schedule.schedule_title }}</h5>
          <p class="card-text">{{ schedule.memo|truncatechars:50 }}</p>
          <p class="card-text"><small class="text-muted">{{ schedule.start_time|date:"Y年m月d日" }}</small></p>
        </div>
        <div class="card-footer text-end">
          <a href="{% url 'app:schedule_detail' schedule.id %}" class="btn btn-outline-primary btn-sm">確認</a>
        </div>
      </div>
    </div>
  {% empty %}
    <p>該当する予定はありません。</p>
  {% endfor %}
</div>

<!-- メモ一覧 -->
<h3 class="mt-4">【該当するメモがあります】</h3>
<div class="row row-cols-1 row-cols-md-2 g-4">
  {% for memo in memos %}
    <div class="col">
      <div class="card h-100">
        {% if memo.image %}
          <img src="{{ memo.image.url }}" class="card-img-top" alt="メモ画像">
        {% endif %}
        <div class="card-body">
          <h5 class="card-title">{{ memo.memo_title }}</h5>
          <p class="card-text">{{ memo.content|truncatechars:50 }}</p>
        </div>
        <div class="card-footer text-end">
          <button class="btn btn-outline-primary btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#memoModal{{ memo.id }}">
            確認
          </button>
        </div>
      </div>
    </div>

    <div class="modal fade" id="memoModal{{ memo.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
          </div>
  
          <div class="modal-body">
            <form method="POST" action="" enctype="multipart/form-data">
              {% csrf_token %}
              <input type="hidden" name="memo_id" value="{{ memo.id }}">
  
              <!-- タイトル -->
              <div class="mb-3">
                {{ memo.form.memo_title.label_tag }}
                {{ memo.form.memo_title }}
              </div>
  
              <!-- 本文 -->
              <div class="mb-3">
                {{ memo.form.content.label_tag }}
                {{ memo.form.content }}
              </div>
  
              <!-- 画像 -->
              <div class="mb-3">
                {{ memo.form.image.label_tag }}
                {{ memo.form.image }}
              </div>
  
              {% if memo.image %}
                <div class="mb-3">
                  <label>現在の画像</label><br>
                  <img src="{{ memo.image.url }}" alt="画像" style="max-width: 300px;">
                </div>
              {% endif %}
  
              <!-- ボタン類 -->
              <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'app:memo_delete' memo.id %}?next={{ request.get_full_path }}" class="btn btn-danger">
                  このメモを削除する
                </a>
                <div>
                  <a href="{{ request.get_full_path }}" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</a>
                  <button type="submit" class="btn btn-primary">完了</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

  {% empty %}
    <p>該当するメモはありません。</p>
  {% endfor %}
</div>

{% if updated_memo_id %}
<script>
   document.addEventListener("DOMContentLoaded", function () {
     const targetModal = document.getElementById("memoModal{{ updated_memo_id }}");
     if (targetModal) {
       const modal = new bootstrap.Modal(targetModal);
       modal.show();
     }
   });
 </script>
{% endif %}

{% endblock %}